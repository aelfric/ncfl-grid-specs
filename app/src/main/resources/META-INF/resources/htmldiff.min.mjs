const t=0,e=1,s=2,n=3,r=4;class i{constructor(t,e,s){this.startInOld=t,this.startInNew=e,this.size=s}get endInOld(){return this.startInOld+this.size}get endInNew(){return this.startInNew+this.size}}const o=/^\s*<\/?[^>]+>\s*$/,l=/<[^\s>]+/,h=/^(\s|&nbsp;)+$/,d=/[\w\#@]+/,c=["<img"];function a(t){return!c.some((e=>null!==t&&t.startsWith(e)))&&o.test(t)}function u(t,e,s){return["<",e,' class="',s,'">',t,"</",e,">"].join("")}function f(t){return"<"===t}function p(t){return"&"===t}function w(t){return";"===t}function I(t){return h.test(t)}function g(t){return a(t)?function(t){return l.exec(t)[0]+(t.endsWith("/>")?"/>":">")}(t):t}function W(t){return d.test(t)}function O(t,e,s){return t.push(e),t.length>s&&t.shift(),t.length!==s?null:t.join("")}class x{constructor(t,e,s,n,r,i,o){this.oldWords=t,this.newWords=e,this.startInOld=s,this.endInOld=n,this.startInNew=r,this.endInNew=i,this.options=o}indexNewWords(){this.wordIndices=new Map;let t=[];for(let e=this.startInNew;e<this.endInNew;e++){let s=O(t,this.normalizeForIndex(this.newWords[e]),this.options.blockSize);null!==s&&(this.wordIndices.has(s)?this.wordIndices.get(s).push(e):this.wordIndices.set(s,[e]))}}normalizeForIndex(t){return t=g(t),this.options.IgnoreWhiteSpaceDifferences&&I(t)?" ":t}findMatch(){if(this.indexNewWords(),this.removeRepeatingWords(),0===this.wordIndices.length)return null;let t=this.startInOld,e=this.startInNew,s=0,n=new Map;const r=this.options.blockSize;let o=[];for(let i=this.startInOld;i<this.endInOld;i++){let l=O(o,this.normalizeForIndex(this.oldWords[i]),r);if(null===l)continue;let h=new Map;if(this.wordIndices.has(l)){for(let o of this.wordIndices.get(l)){let l=(n.has(o-1)?n.get(o-1):0)+1;h.set(o,l),l>s&&(t=i-l-r+2,e=o-l-r+2,s=l)}n=h}else n=h}return 0!==s?new i(t,e,s+r-1):null}removeRepeatingWords(){let t=this.newWords.length+this.options.repeatingWordsAccuracy,e=Array.from(this.wordIndices.entries()).filter((e=>e[1].length>t)).map((t=>t[0]));for(let t of e)this.wordIndices.delete(t)}}class m{constructor(t,e,s,n,r){this.action=t,this.startInOld=e,this.endInOld=s,this.startInNew=n,this.endInNew=r}}class N{constructor(){this.blockSize=0,this.repeatingWordsAccuracy=0,this.ignoreWhitespaceDifferences=!1}}const k=0,b=1,T=2,M=3;function y(t,e){let s={mode:k,currentWord:[],words:[]},n=function(t,e){let s=new Map;if(null===e)return s;for(let n of e){let e;for(;null!==(e=n.exec(t));){if(s.has(e.index))throw new Error("One or more block expressions result in a text sequence that overlaps. Current expression: "+n.toString());s.set(e.index,e.index+e[0].length)}}return s}(t,e),r=!!n.size,i=!1,o=-1;for(let e=0;e<t.length;e++){var l=t[e];if(r){o===index&&(o=-1,i=!1);let t=0;if(n.has(index)&&(t=n.get(index),i=!0,o=t),i){s.currentWord.push(l),s.mode=k;continue}}switch(s.mode){case k:f(l)?D(s,"<",b):p(l)?D(s,l,M):I(l)?D(s,l,T):W(l)&&(0===s.currentWord.length||W(s.currentWord[s.currentWord.length-1]))?s.currentWord.push(l):D(s,l,k);break;case b:">"===l?(s.currentWord.push(l),s.words.push(s.currentWord.join("")),s.currentWord=[],s.mode=I(l)?T:k):s.currentWord.push(l);break;case T:f(l)?D(s,l,b):p(l)?D(s,l,M):I(l)?s.currentWord.push(l):D(s,l,k);break;case M:if(f(l))D(s,l,b);else if(I(l))D(s,l,T);else if(w(l)){let t=!0;if(0!==s.currentWord.length&&(s.currentWord.push(l),s.words.push(s.currentWord.join("")),s.words.length>2&&I(s.words[s.words.length-2])&&I(s.words[s.words.length-1]))){let e=s.words[s.words.length-2],n=s.words[s.words.length-1];s.words.splice(s.words.length-2,2),s.currentWord=[(e+n).split()],s.mode=T,t=!1}t&&(s.currentWord=[],s.mode=k)}else W(l)?s.currentWord.push(l):D(s,l,k)}}return 0!==s.currentWord.length&&s.words.push(s.currentWord.join("")),s.words}function D(t,e,s){0!==t.currentWord.length&&t.words.push(t.currentWord.join("")),t.currentWord=[e],t.mode=s}const S=new Map([["</strong>",0],["</em>",0],["</b>",0],["</i>",0],["</big>",0],["</small>",0],["</u>",0],["</sub>",0],["</strike>",0],["</s>",0],["</dfn>",0]]),j=/<((strong)|(b)|(i)|(dfn)|(em)|(big)|(small)|(u)|(sub)|(sup)|(strike)|(s))[\>\s]+/gi;class z{constructor(t,e){this.content=[],this.newText=e,this.oldText=t,this.specialTagDiffStack=[],this.newWords=[],this.oldWords=[],this.matchGranularity=0,this.blockExpressions=[],this.repeatingWordsAccuracy=1,this.ignoreWhiteSpaceDifferences=!1,this.orphanMatchThreshold=0}build(){if(this.oldText===this.newText)return this.newText;this.splitInputsIntoWords(),this.matchGranularity=Math.min(4,this.oldWords.length,this.newWords.length);let t=this.operations();for(let e of t)this.performOperation(e);return this.content.join("")}addBlockExpression(t){this.blockExpressions.push(t)}splitInputsIntoWords(){this.oldWords=y(this.oldText,this.blockExpressions),this.oldText=null,this.newWords=y(this.newText,this.blockExpressions),this.newText=null}performOperation(i){switch(i.action){case t:this.processEqualOperation(i);break;case e:this.processDeleteOperation(i,"diffdel");break;case s:this.processInsertOperation(i,"diffins");break;case n:break;case r:this.processReplaceOperation(i)}}processReplaceOperation(t){this.processDeleteOperation(t,"diffmod"),this.processInsertOperation(t,"diffmod")}processInsertOperation(t,e){let s=this.newWords.filter(((e,s)=>s>=t.startInNew&&s<t.endInNew));this.insertTag("ins",e,s)}processDeleteOperation(t,e){let s=this.oldWords.filter(((e,s)=>s>=t.startInOld&&s<t.endInOld));this.insertTag("del",e,s)}processEqualOperation(t){let e=this.newWords.filter(((e,s)=>s>=t.startInNew&&s<t.endInNew));this.content.push(e.join(""))}insertTag(t,e,s){for(;s.length;){let n=this.extractConsecutiveWords(s,(t=>!a(t))),r="",i=!1;if(0!==n.length){let s=u(n.join(""),t,e);this.content.push(s)}else{if(j.test(s[0])){let e=s[0].match(j);if(e="<"+e[0].replace(/(<|>| )/g,"")+">",this.specialTagDiffStack.push(e),r='<ins class="mod">',"del"===t)for(s.shift();s.length>0&&j.test(s[0]);)s.shift()}else if(S.has(s[0])){let e=0===this.specialTagDiffStack.length?null:this.specialTagDiffStack.pop();if(null!==e&&e===s[0].replace(/\//g,"")&&(r="</ins>",i=!0),"del"===t)for(s.shift();s.length>0&&S.has(s[0]);)s.shift()}if(0===s.length&&0===r.length)break;i?this.content.push(r+this.extractConsecutiveWords(s,a).join("")):this.content.push(this.extractConsecutiveWords(s,a).join("")+r)}}}extractConsecutiveWords(t,e){let s=null;for(let n=0;n<t.length;n++){let r=t[n];if(0===n&&" "===r&&(t[n]="&nbsp;"),!e(r)){s=n;break}}if(null!==s){let e=t.filter(((t,e)=>e>=0&&e<s));return s>0&&t.splice(0,s),e}{let e=t.filter(((e,s)=>s>=0&&s<t.length));return t.splice(0,t.length),e}}operations(){let o=0,l=0,h=[],d=this.matchingBlocks();d.push(new i(this.oldWords.length,this.newWords.length,0));let c=this.removeOrphans(d);for(let i of c){let d,c=o===i.startInOld,a=l===i.startInNew;d=c||a?c&&!a?s:c?n:e:r,d!==n&&h.push(new m(d,o,i.startInOld,l,i.startInNew)),0!==i.length&&h.push(new m(t,i.startInOld,i.endInOld,i.startInNew,i.endInNew)),o=i.endInOld,l=i.endInNew}return h}*removeOrphans(t){let e=null,s=null;for(let n of t){if(null===s){e=new i(0,0,0),s=n;continue}if(e.endInOld===s.startInOld&&e.endInNew===s.startInNew||s.endInOld===n.startInOld&&s.endInNew===n.startInNew){yield s,e=s,s=n;continue}let t=(t,e)=>t+e.length,r=this.oldWords.slice(e.endInOld,n.startInOld).reduce(t,0),o=this.newWords.slice(e.endInNew,n.startInNew).reduce(t,0);this.newWords.slice(s.startInNew,s.endInNew).reduce(t,0)>Math.max(r,o)*this.orphanMatchThreshold&&(yield s),e=s,s=n}yield s}matchingBlocks(){let t=[];return this.findMatchingBlocks(0,this.oldWords.length,0,this.newWords.length,t),t}findMatchingBlocks(t,e,s,n,r){let i=this.findMatch(t,e,s,n);null!==i&&(t<i.startInOld&&s<i.startInNew&&this.findMatchingBlocks(t,i.startInOld,s,i.startInNew,r),r.push(i),i.endInOld<e&&i.endInNew<n&&this.findMatchingBlocks(i.endInOld,e,i.endInNew,n,r))}findMatch(t,e,s,n){for(let r=this.matchGranularity;r>0;r--){let i=new N;i.blockSize=r,i.repeatingWordsAccuracy=this.repeatingWordsAccuracy,i.ignoreWhitespaceDifferences=this.ignoreWhiteSpaceDifferences;let o=new x(this.oldWords,this.newWords,t,e,s,n,i).findMatch();if(null!==o)return o}return null}}z.execute=function(t,e){return new z(t,e).build()};export{z as default};
